---
title: "Final Project"
author: "Ingrid J. Lu 260773949;"
date: "28/10/2021"
output: pdf_document
---

```{r setup, include=FALSE}
## ---- Setup -----------------------------------------------------------------
knitr::opts_chunk$set(
warning = FALSE,
message = FALSE,
cache = FALSE,
fig.align = "center",
fig.asp = 1
)

library(pacman)
p_load(ggplot2, tidyverse, here, readxl, mosaic, pwr, ggpubr, car)
theme_set(theme_light())
```

```{r}
# Set-up
df_fh <- readr::read_csv(here::here("fetal_health.csv")) %>% 
  select(!starts_with("histogram"))
```
# Background
Your sister and her partner are expecting a child soon, and she just went to her obstetrician for her routine check. Because she in her second trimester, her obstetrician asks her to do a fetal cardiogram. The results will not get back to her until a week later. Your sister is a bit of a hypochondriac, so she is afraid that there is something wrong with her child. 

So, her partner turns to you, a Masters student who is studying inferential statistics for health, hoping to find some results to calm your sister down.

Luckily, you have identified a publicly available dataset that includes thousands of fetal cardiogram results, and the classification of these babiesâ€™ health status. You need to convince your sister that she and her child will be safe.

Note: the objective of this exercise is to consolidate all the important concepts covered in EPIB607. When answer each question, be sure to include any units and assumptions and define all parameters, when appropriate. The following questions are based on the publicly available dataset ["Fetal Classification"](https://archive.ics.uci.edu/ml/datasets/cardiotocography), please find all attribute information of the data from the link.

# Question 1 Data Visualization and Summary Statistics

## a) {-}
Is this data tidy? If no, transform it into an untidy data. If yes, provide an explanation.

*Solution:*

## b) {-}
Looking at the 3 different classification of fetal health status and each fetus' baseline heart rate provide an appropriate graphic summarizing the distribution of each of baseline heart rates for each class. Be sure to provide the correct title and label for the plot.

*Solution:*

```{r}
#----Question 1----------

# 1.b
df_fh$fetal_health <- ifelse(df_fh$fetal_health == 1, 
                             "Normal", 
                             ifelse(df_fh$fetal_health == 2, 
                                    "Suspect", 
                                    "Pathological"))

df_fh %>% 
  group_by(fetal_health) %>%
  ggplot(aes(x = fetal_health, y = `baseline value`)) +
  geom_boxplot()
```

## c) {-}
Comment on the boxplot, what are the characteristics of each category?

## d) {-}

Describe the distribution of the baseline heart rate for all participants in this sample, is the baseline heart rate normally distributed, comment on any skewness. What about each class? Use an appropriate graph to answer this question.

*Solution:*

```{r}
## 1.d

df_fh %>% 
  ggplot(aes(x = `baseline value`))+
  geom_density()

df_fh %>% 
  ggplot(aes(x = `baseline value`, fill = fetal_health))+
  geom_density(alpha = 0.5)

```

# Question 2

## a) {-}

Your sister thinks that more uterine contraction means that her fetus is unhealthy and she is more likely to give a pre-term birth. 

Is her statement true? What is the mean uterine contraction for each class?

*Solution:*

```{r}
#----Question 2--------------
df_fh_n <- df_fh %>% filter(fetal_health == "Normal")
mean(df_fh_n$uterine_contractions)

df_fh_s <- df_fh %>% filter(fetal_health == "Suspect")
mean(df_fh_s$uterine_contractions)

df_fh_p <- df_fh %>% filter(fetal_health == "Pathological")
mean(df_fh_p$uterine_contractions)
```
Looking at the mean, this statement is not true. The Normal category has the highest number of mean uterine contractions. And the mean uterine contraction in the Pathological category is lower than the mean in the Normal category. The Suspect category has the lowest mean uterine contractino out of the three classes.

Nevertheless, further testing is required to confirm this observation.


## b) {-}

Since we have a small sample size for those who are suspected to be pathological and those who are determined to be pathological, what is one method that we can use to artificially create a pseudo-population and calculate the median of these two groups? State your assumptions.

*Solution:*  Bootstrapping

```{r}
B <- 1000
set.seed(3949)

R_s <- replicate(B, { # first argument, # of replicates
  df_fh_s %>% 
    dplyr::slice_sample(n = nrow(df_fh_s), replace = T) %>%
    summarise(mean = mean(df_fh_s$uterine_contractions)) %>%
    pull(mean)
})

mean(R_s)

R_p <- replicate(B, { # first argument, # of replicates
  df_fh_p %>% 
    dplyr::slice_sample(n = nrow(df_fh_p), replace = T) %>%
    summarise(mean = mean(df_fh_p$uterine_contractions)) %>%
    pull(mean)
})

mean(R_p)
```

## c) {-}

What is one weakness of using the bootstrapping method?

Solution: The bootstrapping method assumes that the sample is representative of the whole population. However, when we have a small sample size, that is not always the case. There could be sampling errors which can skew the distribution of the sample. And the bootstrapping method cannot correct this error as it can only sample within this small set of data. As the saying goes, "garbage in, garbage out". If the sample is not representative of the population, the results obtained from bootstrap will not be accurate and will result in an incorrect inference of the population parameter.

## d) {-}

Your sister is also concerned that her baby does not move as much, which could be a sign of unhealthy pregnancy.

Transform x-axis to a logarithmic scale.

```{r}
# 2.d

df_fh %>% 
  ggplot(aes(x = fetal_movement, fill = fetal_health))+
  geom_density(alpha = 0.5) + 
  scale_x_log10()

```

```{r}
# Question 3
```

# Question 4. p-value, power {-}

For the purpose of this question only, we treat the 2126 individuals as **the entire target population of newborns**. 

## 1) Calculate the mean and standard deviation of the baseline fetal heart rate.

```{r}
mean_hr <- mean(df_fh$`baseline value`)
mean_hr
sd_hr <- sqrt(var(df_fh$`baseline value`)*(length(df_fh$`baseline value`)-1)/length(df_fh$`baseline value`))
sd_hr
```

## 2) It is claimed that the baseline fetal heart rates of fetuses with "suspect" health status are above average. Take a simple random sample of 10 fetuses with "suspect" health status, and measure their heart rate to obtain a sample mean of 141.68. Heart rates are scaled to be normally distributed. Does the sample provide evidence to reject null hypothesis? State your null and alternative hypothesis.

```{r}
pnorm(q = 141.68, mean = 133.30, sd = 9.84/sqrt(10), lower.tail = FALSE)
```

$H_0: \mu = 133.30$, $H_A: \mu > 133.30$

The p-value of one sided test is 0.0035. This sample provides evidence against the null hypothesis. The p-value tells us the probability of observing the sample size mean of 141.68 under the null hypothesis distribution is very unlikely.

## 3) What power do you have to detect the baseline fetal heart rates of fetuses with "suspect" health status are at least 8.38 heart beats higher than average, using a one-sided test and sample size 10 and a 0.05 level test?

$H_0: \mu = 133.30$, $H_A: \mu > 141.30$
```{r}
# cutoff to reject the null
cutoff <- qnorm(p = 0.95, mean = 133.30, sd = 9.84/sqrt(10))
cutoff
# probability of observing this cutoff or greater under the alternative
pnorm(q = cutoff, mean = 141.68, sd = 9.84/sqrt(10), lower.tail = FALSE)
```

## 4) A sample size of 10 fetuses with "suspect" health status will have at least 85% power to detect a difference of 8.38 heart beats. Use a simulation based approach to reproduce the sample size calculation for the baseline fetal heart rates of fetuses with "suspect" health status and average.

```{r}
set.seed(490)

power_distribution <- replicate(n = 1000, expr={
  sample.size <- 10
  
  suspect <- rnorm(sample.size, mean = 141.68, sd = 9.83)
  SEM <- sd(suspect)/sqrt(sample.size)
  
  pnorm(q = mean(suspect), mean = 133.30, sd =SEM, lower.tail = FALSE) < 0.05

} )

prop.table(table(power_distribution))
```

The percentage of samples that results in a p-value less than 0.05 is 85.4%, which shows the study is powered at 85% to detect the difference.

# Question 5 
Suppose this data represents the population of newborns in one hospital and you take a simple random sample of 100 babies from the population.

## a) What is the probability that your sample contains more than 25 babies has abnormal health status (1 = health, 2 = suspect, 3 = Pathological)? 

```{r}
## ---- Question-5a ------------------------------------------------------------
df_fh %>%
  select(fetal_health)%>%
  filter(fetal_health != 1)%>%
  nrow()
#there are 471 abnormal in this population
#the probability of having abnormal is 471/2126 = 0.22
1 - mosaic::xpbinom(q = 25, size = 100, prob = 0.22)
```
The probability of having more than 30 abnormal is 0.197. 

## b) Turns out that your sample actually contains 20 babies with abnormal health status. What is the 95% confidence interval of this proportion? Can you use a normal approximation for this sample? Why or why not?
```{r}
## ---- Question-5b ------------------------------------------------------------
mosaic::binom.test(x = 200, n = 1000, ci.method = "Clopper-Pearson")
mosaic::binom.test(x = 200, n = 1000, ci.method = "Wald")
mosaic::binom.test(x = 20, n = 100, ci.method = "Clopper-Pearson")
mosaic::binom.test(x = 20, n = 100, ci.method = "Wald")
```
The 95% CI using Clopper-Pearson method: [0.127,0.292]
The 95% CI using exact method(ie: normal approximation): [0.122,0.278]
The two methods give similar 95% CIs. Normal approximation can be used here since the sample size is large enough to generate a binomial distribution approximating the normal distribution and for CLT to kick in. 

## c) Another sample taken have the same proportion of event but the sample size is now only 10 and the count of abnormal is 2. Calculate the 95% CI using this sample and compare it with the one you have in b). Describe their difference and the reason why. 
```{r}
## ---- Question-5c ------------------------------------------------------------
mosaic::binom.test(x = 2, n = 10, ci.method = "Clopper-Pearson")
```
The 95% CI for this sample is: [0.0252, 0.556].
95% CI in c) with sample size = 10 is wider than the 95% CI in b) with sample size = 100. 
The sample size is different so the standard error is different. The 95% CI is calculated using the formula: 
$$
\bar y - 1.96(\frac {\sigma} {\sqrt n}) , \bar y + 1.96(\frac {\sigma} {\sqrt n}) 
$$
If the sample size n is larger, the standard error(sigma/sqrt n) is smaller. The value 1.96*standard error is also smaller, and results in a narrower confident interval.


\newpage

```{r}
# Question 6
```
